<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hot Kitchen Input Form</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;

      /* Big cooking pot kitchen background */
      background: url('https://images.freerangestock.com/sample/186850/chef-cooking-large-pots-with-steaming-delicious-food.jpg') no-repeat center center;
      background-size: cover;
    }

    .form-container {
      width: 420px;
      padding: 28px;
      border-radius: 16px;
      background: rgba(0, 0, 0, 0.5); /* semi‑transparent card for readability */
      color: #fff;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    label {
      display: block;
      margin-top: 14px;
      font-size: 14px;
    }

    input[type="number"] {
      width: 100%;
      margin-top: 6px;
      padding: 12px;
      border-radius: 10px;
      border: none;
      outline: none;
      font-size: 15px;
    }

    input[type="number"]:focus {
      box-shadow: 0 0 0 2px #ff8c00;
    }

    input[type="number"]:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    button {
      margin-top: 26px;
      width: 100%;
      padding: 14px;
      border-radius: 30px;
      border: none;
      background: linear-gradient(135deg, #ff4500, #ff8c00);
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.25);
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .notification {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      text-align: center;
      font-weight: 500;
      display: none;
    }

    .notification.success {
      background-color: rgba(76, 175, 80, 0.3);
      border: 1px solid #4caf50;
      color: #c8e6c9;
      display: block;
    }

    .notification.error {
      background-color: rgba(244, 67, 54, 0.3);
      border: 1px solid #f44336;
      color: #ffcdd2;
      display: block;
    }

    .notification.warning {
      background-color: rgba(255, 193, 7, 0.3);
      border: 1px solid #ffc107;
      color: #ffe0b2;
      display: block;
    }

    .loading {
      text-align: center;
      padding: 20px;
      font-size: 14px;
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #fff;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div class="form-container">
    <div id="notification" class="notification"></div>
    <h2>Hot Kitchen Submission</h2>

    <div id="loadingContent" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Validating access...</p>
    </div>

    <form id="dataForm" style="display: none;">
      <input type="hidden" name="area" value="Hot Kitchen">
      <input type="hidden" id="tokenField" name="token" value="">
      
      <label>Total Requested Quantity (kg)</label>
      <input type="number" name="requested_qty" min="0" step="0.01" required>

      <label>Production Quantity (kg)</label>
      <input type="number" name="production_qty" min="0" step="0.01" required>

      <label>Wastage Quantity (kg)</label>
      <input type="number" name="wastage_qty" min="0" step="0.01">

      <label>Opening Stock (kg)</label>
      <input type="number" name="opening_stock" min="0" step="0.01" required>

      <button id="submitBtn" type="submit">Submit</button>
    </form>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const apiParam = urlParams.get('api');
    
    // Determine API base
    let API_BASE;
    if (apiParam) {
      // Use provided API URL and ensure it uses http:// for private IP addresses
      let decodedUrl = decodeURIComponent(apiParam);
      // If it's a protocol-relative URL (//...) or https://..., convert to http:// for private IPs
      if (decodedUrl.startsWith('//')) {
        decodedUrl = 'http:' + decodedUrl;
      } else if (decodedUrl.startsWith('https://')) {
        decodedUrl = decodedUrl.replace('https://', 'http://');
      }
      API_BASE = decodedUrl;
    } else {
      // Fallback to encoded URL
      const encodedUrl = 'aHR0cDovL2xvY2FsaG9zdDo4MDAwL2FwaS9mb3Jtcy9zdWJtaXQ=';
      API_BASE = atob(encodedUrl).replace('/submit', '');
    }
    
    const token = urlParams.get('token');

    const form = document.getElementById('dataForm');
    const loadingContent = document.getElementById('loadingContent');
    const notification = document.getElementById('notification');
    const tokenField = document.getElementById('tokenField');
    const submitBtn = document.getElementById('submitBtn');
    const formInputs = form.querySelectorAll('input[type="number"]');

    async function validateToken() {
      try {
        loadingContent.style.display = 'block';
        form.style.display = 'none';
        notification.style.display = 'none';

        if (!token) {
          showNotification('No access token provided. Please use the link sent to you.', 'error');
          loadingContent.style.display = 'none';
          return;
        }

        const response = await fetch(`${API_BASE}/api/forms/validate-token?token=${encodeURIComponent(token)}`);
        const result = await response.json();
        loadingContent.style.display = 'none';

        if (!result.success || !result.data.valid) {
          showNotification('Invalid or expired token. The submission window has closed.', 'error');
          return;
        }

        if (result.data.submitted) {
          showNotification('Compliance Form For Today has been submitted.', 'success');
          form.style.display = 'block';
          disableAllInputs();
          return;
        }

        tokenField.value = token;
        form.style.display = 'block';
        showNotification('Form loaded successfully. Please fill in the details.', 'warning');

      } catch (error) {
        loadingContent.style.display = 'none';
        showNotification('Error validating access: ' + error.message, 'error');
        console.error('Token validation error:', error);
      }
    }

    function showNotification(message, type) {
      notification.textContent = message;
      notification.className = 'notification ' + type;
      notification.style.display = 'block';
    }

    function disableAllInputs() {
      formInputs.forEach(input => {
        input.disabled = true;
      });
      submitBtn.disabled = true;
      submitBtn.textContent = 'Already Submitted';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        const response = await fetch(`${API_BASE}/api/forms/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showNotification('✓ Submission successful!', 'success');
          disableAllInputs();
          submitBtn.textContent = 'Submitted';
        } else {
          showNotification(result.message || 'Submission failed. Please try again.', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit';
        }
      } catch (error) {
        showNotification('Error submitting form: ' + error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
      }
    });

    validateToken();
  </script>

</body>
</html>
